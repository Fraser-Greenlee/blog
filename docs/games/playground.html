<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pyxel Playground</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/kitao/pyxel/wasm/pyxel.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      height: 100vh;
      font-family: "Press Start 2P", serif;
      font-weight: 400;
      font-style: normal;
    }

    .container {
      height: 100vh;
      display: flex;
      gap: 0;
      padding: 4px;
      background: #1e1e1e;
      position: relative;
    }
    
    .resizer {
      width: 8px;
      height: 100%;
      background: #333;
      cursor: col-resize;
      transition: background 0.2s;
      margin: 0 4px;
      z-index: 10;
    }
    
    .resizer:hover {
      background: #555;
    }
    
    .resizer.active {
      background: #4CAF50;
    }

    .editor-panel {
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
      overflow: hidden;
      flex: 1;
      min-width: 200px;
    }

    .editor-header {
      display: flex;
      background: #2d2d2d;
      border-bottom: 1px solid #333;
      padding: 8px 16px;
    }

    .editor-title {
      color: #fff;
      font-family: "Press Start 2P", serif;
      font-size: 10px;
    }

    .editor-actions {
      display: flex;
      background: #2d2d2d;
      padding: 4px;
      gap: 8px;
      border-bottom: 1px solid #333;
      justify-content: space-between;
    }
    
    .spacer {
      flex-grow: 1;
    }
    
    .examples-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333;
      min-width: 200px;
      max-height: 400px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
      z-index: 100;
      border-radius: 4px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .examples-dropdown:hover .dropdown-content {
      display: block;
    }
    
    .dropdown-content a {
      color: white;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 10px;
      text-align: left;
      transition: background-color 0.2s;
    }
    
    .dropdown-content a:hover {
      background-color: #444;
    }

    .action-button {
      padding: 8px 12px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Press Start 2P", serif;
      font-size: 10px;
      transition: background 0.2s;
    }

    .action-button:hover {
      background: #555;
    }

    .editor-container {
      position: relative;
      flex-grow: 1;
    }
    
    #editor-tabs {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .editor-tab {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      display: none;
    }
    
    .editor-tab.active {
      display: block;
    }
    
    #editor {
      width: 100%;
      height: 100%;
    }
    
    #media-editor {
      width: 100%;
      height: 100%;
      background: #1e1e1e;
    }
    
    .tab-buttons {
      display: flex;
      gap: 4px;
    }
    
    .tab-button {
      padding: 8px 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      font-family: "Press Start 2P", serif;
      font-size: 10px;
      transition: background 0.2s;
    }
    
    .tab-button:hover {
      background: #444;
    }
    
    .tab-button.active {
      background: #4CAF50;
    }

    .right-panel {
      display: flex;
      flex-direction: column;
      background: #2d2d2d;
      border-radius: 4px;
      overflow: hidden;
      flex: 1;
      min-width: 200px;
    }

    .tab-content {
      display: flex;
      flex-grow: 1;
      height: 100%;
    }

    canvas {
      background: #000;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    #game-content {
      flex-grow: 1;
      position: relative;
      /* For proper Pyxel canvas positioning */
    }


    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
      background-color: #2d2d2d;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #444;
      width: 50%;
      max-width: 500px;
      border-radius: 8px;
      color: #fff;
      font-family: "Press Start 2P", serif;
      font-size: 12px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 16px;
    }

    .close-modal {
      color: #888;
      font-size: 20px;
      cursor: pointer;
    }

    .close-modal:hover {
      color: #fff;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background-color: #333;
      border: 1px solid #444;
      color: #fff;
      font-family: monospace;
      border-radius: 4px;
    }

    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Press Start 2P", serif;
      font-size: 10px;
    }

    .modal-btn-primary {
      background-color: #4CAF50;
      color: white;
    }

    .modal-btn-secondary {
      background-color: #555;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="editor-panel">
      <div class="editor-actions">
        <div class="examples-dropdown">
          <button class="action-button" id="examples-button">ðŸŽ® Examples</button>
          <div class="dropdown-content">
            <a href="#" data-example="perlin_noise">Perlin Noise</a>
            <a href="#" data-example="triangle_api">Triangle API</a>
            <a href="#" data-example="click_game">Click Game</a>
            <a href="#" data-example="snake">Snake</a>
            <a href="#" data-example="shooter">Shooter</a>
            <a href="#" data-example="platformer">Platformer</a>
            <a href="#" data-example="jump_game">Jump Game</a>
            <a href="#" data-example="tetris">Tetris</a>
            <a href="#" data-example="lander">Lander</a>
            <a href="#" data-example="baba_is_you">Baba Is You</a>
            <a href="#" data-example="mincraft">Mincraft</a>
          </div>
        </div>
        <button class="action-button" id="copy-setup-button">Prompt ChatGPT</button>
        <button class="action-button" id="copy-code-button">Copy Code</button>
        <button class="action-button" id="paste-button">Paste</button>
        <button class="action-button" id="download-button">Download</button>
        <button class="action-button" id="upload-button">Upload</button>
        <input type="file" id="pyxapp-file-input" accept=".pyxapp" style="display: none;">
        <div class="spacer"></div>
        <div class="tab-buttons">
          <button class="tab-button active" id="code-tab-button">ðŸ’»</button>
          <button class="tab-button" id="media-tab-button">ðŸŽ¨</button>
        </div>
      </div>
      <div class="editor-container">
        <div id="editor-tabs">
          <div id="editor" class="editor-tab active">import pyxel

pyxel.init(160, 120)

def update():
  if pyxel.btnp(pyxel.KEY_Q):
    pyxel.quit()

def draw():
  pyxel.cls(0)
  pyxel.text(55, 41, "Hello, Pyxel!", pyxel.frame_count % 16)

pyxel.run(update, draw)</div>
          <div id="media-editor" class="editor-tab">
            <!-- Media editor iframe will be placed here -->
          </div>
        </div>
      </div>
    </div>

    <div class="resizer" id="panel-resizer"></div>

    <div class="right-panel">
      <div id="game-content" class="tab-content">
        <!-- Game Container will be populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    // Store our editor
    let editor;
    let resourceData = "";
    let gameIframe = null;
    let mediaIframe = null;
    
    // Initialize the editor
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setOptions({
        fontSize: "14px",
        showPrintMargin: false,
        highlightActiveLine: true,
        enableLiveAutocompletion: true
    });
    
    // Initialize the tabs
    showCodeEditor();
    
    // Function to update or create the game iframe
    function updateGame() {
        const gameContainer = document.getElementById('game-content');
        const code = editor.getValue();
        
        // Store the code in sessionStorage to avoid URL size limitations
        sessionStorage.setItem('pyxelCode', code);
        sessionStorage.setItem('pyxelResource', resourceData);
        
        // If there's an existing iframe, just update its src
        if (gameIframe && gameIframe.parentNode === gameContainer) {
            gameIframe.src = 'player.html?useSessionStorage=true';
        } else {
            // Create a new iframe
            gameContainer.innerHTML = '';
            gameIframe = document.createElement('iframe');
            gameIframe.style.width = '100%';
            gameIframe.style.height = '100%';
            gameIframe.style.border = 'none';
            
            // Use sessionStorage instead of URL parameters
            gameIframe.src = 'player.html?useSessionStorage=true';
            
            gameContainer.appendChild(gameIframe);
        }
    }
    
    // Function to load a project
    function deserializeProject(projectData) {
        // Get the content of main.py
        const mainFile = 'main.py';
        const content = projectData.files[mainFile];
        
        // Update editor content
        editor.setValue(content, -1);
        
        // Set resource data
        resourceData = projectData.resourceData || "";
        
        // Update the game display
        updateGame();
        
        // If the media editor iframe exists, reload it to show the new resources
        if (mediaIframe) {
            // Remove the old iframe
            const mediaEditorContainer = document.getElementById('media-editor');
            mediaEditorContainer.innerHTML = '';
            mediaIframe = null;
            
            // If media tab is currently active, immediately reinitialize the media editor
            if (document.getElementById('media-editor').classList.contains('active')) {
                initializeMediaEditor();
            }
            // Otherwise, it will be initialized the next time the Media tab is clicked
        }
    }

    // Add a save button to the editor actions
    const saveButton = document.createElement('button');
    saveButton.classList.add('action-button');
    saveButton.textContent = 'ðŸ’¾';
    saveButton.id = 'save-button';
    document.querySelector('.editor-actions').appendChild(saveButton);
    
    // Track if content has unsaved changes
    let hasUnsavedChanges = false;
    
    // Function to update save button appearance
    function updateSaveButtonState(unsaved) {
        hasUnsavedChanges = unsaved;
        const saveButton = document.getElementById('save-button');
        if (unsaved) {
            saveButton.textContent = 'ðŸ’¾*';
            saveButton.style.background = '#ff9800';
        } else {
            saveButton.textContent = 'ðŸ’¾';
            saveButton.style.background = '';
        }
    }
    
    // Add event listener for the save button
    document.getElementById('save-button').addEventListener('click', () => {
        if (gameIframe) {
            updateGame();
            updateSaveButtonState(false);
        }
    });
    
    // Add event listener for cmd+s/ctrl+s
    editor.commands.addCommand({
        name: 'saveCommand',
        bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
        exec: function() {
            if (gameIframe) {
                updateGame();
                updateSaveButtonState(false);
            }
            return true; // Prevent browser's save dialog
        }
    });
    
    // Flag to ignore the first change event after loading an example
    let ignoreNextChange = false;
    
    // Add event listener to detect code changes
    editor.session.on('change', (e) => {
        // If we should ignore this change (from loading an example), don't update save button
        if (ignoreNextChange) {
            ignoreNextChange = false;
            return;
        }
        updateSaveButtonState(true);
    });
    
    // Override setValue to set the ignore flag
    const originalSetValue = editor.setValue;
    editor.setValue = function(val, cursorPos) {
        ignoreNextChange = true;
        return originalSetValue.call(this, val, cursorPos);
    };
    
    // Initialize the game on page load 
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the game view
        updateGame();
    });
    
    // Initialize the game immediately in case DOMContentLoaded already fired
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        updateGame();
    }
    
    // Example project metadata
    const exampleProjects = {
        jump_game: {
            title: "Jump Game",
            path: "sample_games/jump_game/game.py",
            resourceData: "sample_games/jump_game/game.pyxres"
        },
        click_game: {
            title: "Click Game",
            path: "sample_games/click_game/game.py",
            resourceData: "sample_games/click_game/game.pyxres"
        },
        snake: {
            title: "Snake",
            path: "sample_games/snake/game.py",
            resourceData: "sample_games/snake/game.pyxres"
        },
        triangle_api: {
            title: "Triangle API",
            path: "sample_games/triangle_api/game.py",
            resourceData: "sample_games/triangle_api/game.pyxres"
        },
        shooter: {
            title: "Shooter",
            path: "sample_games/shooter/game.py",
            resourceData: "sample_games/shooter/game.pyxres"
        },
        platformer: {
            title: "Platformer",
            path: "sample_games/platformer/game.py",
            resourceData: "sample_games/platformer/game.pyxres"
        },
        perlin_noise: {
            title: "Perlin Noise",
            path: "sample_games/perlin_noise/game.py",
            resourceData: "sample_games/perlin_noise/game.pyxres"
        },
        baba_is_you: {
            title: "Baba Is You",
            path: "sample_games/baba_is_you/game.py",
            resourceData: "sample_games/baba_is_you/game.pyxres"
        },
        tetris: {
            title: "Tetris",
            path: "sample_games/tetris/game.py",
            resourceData: "sample_games/tetris/game.pyxres"
        },
        lander: {
            title: "Lander",
            path: "sample_games/lander/game.py",
            resourceData: "sample_games/lander/game.pyxres"
        },
        mincraft: {
            title: "Mincraft",
            path: "sample_games/mincraft/game.py",
            resourceData: "sample_games/mincraft/game.pyxres"
        },
    };
    
    // Function to load example code from file
    async function loadExampleFile(path) {
        try {
            const response = await fetch(path);
            if (!response.ok) {
                throw new Error(`Failed to fetch example: ${response.status} ${response.statusText}`);
            }
            return await response.text();
        } catch (error) {
            console.error("Error loading example:", error);
            return "# Error loading example\n# " + error.message;
        }
    }
    
    // Function to fetch resource data (if available)
    async function fetchResourceData(resourcePath) {
        if (!resourcePath) return "";
        
        try {
            const response = await fetch(resourcePath);
            if (!response.ok) {
                throw new Error(`Failed to fetch resource: ${response.status} ${response.statusText}`);
            }
            // Just verify the resource exists and return the path for later use
            return resourcePath;
        } catch (error) {
            console.error("Error loading resource:", error);
            return "";
        }
    }
    
    // Add event listeners for example selection
    document.querySelectorAll('.dropdown-content a').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const exampleId = e.target.getAttribute('data-example');
            const example = exampleProjects[exampleId];
            
            if (example) {
                try {
                    // Show loading indicator
                    document.body.style.cursor = 'wait';
                    
                    // Load the example code and resource data in parallel
                    const [content, resourcePath] = await Promise.all([
                        loadExampleFile(example.path),
                        fetchResourceData(example.resourceData)
                    ]);
                    
                    // Create a project object that matches our existing deserializeProject format
                    const projectData = {
                        files: {
                            'main.py': content
                        },
                        resourceData: resourcePath || ""
                    };
                    
                    // Load the project into the editor
                    deserializeProject(projectData);
                    
                    // Reset the save button state to not highlight as if modified
                    updateSaveButtonState(false);
                    
                    // Set the document title to include the example name
                    document.title = `Pyxel Playground - ${example.title}`;
                } catch (error) {
                    console.error("Failed to load example:", error);
                    alert("Failed to load example: " + error.message);
                } finally {
                    // Reset cursor
                    document.body.style.cursor = '';
                }
            }
        });
    });
    
    // ChatGPT Integration
    document.getElementById('copy-code-button').addEventListener('click', () => {
        const code = editor.getValue();
        
        // Copy to clipboard
        navigator.clipboard.writeText(code).then(() => {
            // Change button text briefly to show success
            const btn = document.getElementById('copy-code-button');
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        });
    });
    
    document.getElementById('copy-setup-button').addEventListener('click', () => {
        const setupPrompt = `I'm working with Pyxel, a retro game engine for Python. 

Pyxel is a retro game engine for Python that lets you create pixel art games easily.
I am using a simple website to run and edit Pyxel so I can only use one python script and one 'game.pyxres' file.
I am new to programming so explain things simply to me and take me through what you are doing step by step including debugging features to make things more clear.

Key features of Pyxel:
- 16 color palette
- 3 banks of 256x256 sized images
- 8 tilemaps of 256x256 size
- 4 sound channels with 64 definable sounds
- 8 music banks, each capable of combining 64 sounds
- Keyboard, mouse, and gamepad input
- Image and sound editor

Pyxel uses the following drawing functions:
- cls(col): Clear screen with color
- pix(x, y, col): Draw a pixel
- line(x1, y1, x2, y2, col): Draw a line
- rect(x, y, w, h, col): Draw a rectangle
- rectb(x, y, w, h, col): Draw the outline of a rectangle
- circ(x, y, r, col): Draw a circle
- circb(x, y, r, col): Draw the outline of a circle
- blt(x, y, img, u, v, w, h, [colkey]): Draw an image from the resource
- text(x, y, s, col): Draw text

Pyxel's main flow is:
1. Initialize with pyxel.init(width, height, ...)
2. Define update() and draw() functions
3. Run the game loop with pyxel.run(update, draw)

The update() function runs game logic, and draw() renders the game state.

Keyboard input is handled with:
- pyxel.btn(key): Check if a key is held down
- pyxel.btnp(key): Check if a key was just pressed
- pyxel.btnr(key): Check if a key was just released

Common keys are: pyxel.KEY_Q, pyxel.KEY_SPACE, etc.

Note that I am using the Pyodide web version of pyxel.`;

        // Copy to clipboard
        navigator.clipboard.writeText(setupPrompt).then(() => {
            // Change button text briefly to show success
            const btn = document.getElementById('copy-setup-button');
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
            
            // Open ChatGPT in a new tab
            window.open('https://chat.openai.com', '_blank');
        });
    });
    
    document.getElementById('paste-button').addEventListener('click', () => {
        // Ask for permission to read clipboard
        navigator.clipboard.readText().then(text => {
            // Set editor content
            editor.setValue(text, -1);
            
            // Update save state to indicate changes
            updateSaveButtonState(true);
            
            // Show brief confirmation
            const btn = document.getElementById('paste-button');
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Pasted!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }).catch(err => {
            console.error('Failed to read clipboard: ', err);
            alert('Could not access clipboard. Make sure you\'ve granted clipboard permission to this site.');
        });
    });

    // Panel resizer functionality
    const panelResizer = document.getElementById('panel-resizer');
    const editorPanel = document.querySelector('.editor-panel');
    const rightPanel = document.querySelector('.right-panel');
    
    // Initialize with stored panel sizes if available, otherwise use default 50/50
    const storedEditorWidth = localStorage.getItem('pyxelEditorWidth');
    if (storedEditorWidth) {
        editorPanel.style.flex = '0 0 ' + storedEditorWidth + 'px';
    } else {
        // Default to 50% of container width
        const containerWidth = document.querySelector('.container').clientWidth;
        editorPanel.style.flex = '0 0 ' + (containerWidth / 2) + 'px';
    }
    
    // Resize functionality
    let isResizing = false;
    let lastDownX = 0;
    
    panelResizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        lastDownX = e.clientX;
        panelResizer.classList.add('active');
        
        // Prevent text selection during resize
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'col-resize';
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerRect = document.querySelector('.container').getBoundingClientRect();
        const offsetX = e.clientX - containerRect.left;
        
        // Calculate min/max values
        const minWidth = 200; // Minimum editor width
        const maxWidth = containerRect.width - 200; // Maximum editor width (leaving min space for right panel)
        
        // Apply constraints
        const newWidth = Math.min(Math.max(offsetX, minWidth), maxWidth);
        
        // Update editor panel width
        editorPanel.style.flex = '0 0 ' + newWidth + 'px';
        
        // Force Ace editor to update its size
        if (editor) {
            editor.resize();
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            panelResizer.classList.remove('active');
            
            // Reset cursor and selection
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
            
            // Save the editor width for next time
            const editorWidth = editorPanel.offsetWidth;
            localStorage.setItem('pyxelEditorWidth', editorWidth);
            
            // Make sure editor resizes properly
            if (editor) {
                editor.resize();
            }
        }
    });
    
    // Resize editor when window changes
    window.addEventListener('resize', () => {
        // Resize editor to fit the new layout
        if (editor) {
            editor.resize();
        }
        
        // Update game iframe if it exists
        if (gameIframe) {
            // Ensure panels maintain reasonable sizes in new window dimensions
            const containerWidth = document.querySelector('.container').clientWidth;
            const minWidth = 200;
            const currentEditorWidth = parseInt(editorPanel.style.flex.split(' ')[2]);
            
            // If editor is too large or small after resize, adjust it
            if (currentEditorWidth > containerWidth - minWidth || currentEditorWidth < minWidth) {
                const newWidth = Math.min(Math.max(containerWidth / 2, minWidth), containerWidth - minWidth);
                editorPanel.style.flex = '0 0 ' + newWidth + 'px';
            }
        }
    });

    // Function to initialize the media editor
    function initializeMediaEditor() {
        const mediaEditorContainer = document.getElementById('media-editor');
        
        // Create the iframe for the media editor if it doesn't exist yet
        if (!mediaIframe) {
            // Store the resource data in sessionStorage if we have it
            if (resourceData) {
                if (typeof resourceData === 'string' && (resourceData.startsWith('data:') || resourceData.match(/^[A-Za-z0-9+/=]+$/))) {
                    // This is already base64 data
                    sessionStorage.setItem('pyxelResourceForEditor', resourceData);
                    mediaIframe = document.createElement('iframe');
                    mediaIframe.style.width = '100%';
                    mediaIframe.style.height = '100%';
                    mediaIframe.style.border = 'none';
                    mediaIframe.src = 'media.html';
                } else {
                    // This is a path to a resource file - fetch it and convert to base64
                    fetch(resourceData)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Failed to fetch resource: ${response.status} ${response.statusText}`);
                            }
                            return response.arrayBuffer();
                        })
                        .then(buffer => {
                            // Convert to base64
                            const base64Data = btoa(
                                new Uint8Array(buffer)
                                    .reduce((data, byte) => data + String.fromCharCode(byte), '')
                            );
                            
                            // Store in sessionStorage
                            sessionStorage.setItem('pyxelResourceForEditor', base64Data);
                            
                            // Create and load the iframe
                            mediaIframe = document.createElement('iframe');
                            mediaIframe.style.width = '100%';
                            mediaIframe.style.height = '100%';
                            mediaIframe.style.border = 'none';
                            mediaIframe.src = 'media.html';
                            mediaEditorContainer.appendChild(mediaIframe);
                        })
                        .catch(error => {
                            console.error('Error loading resource file:', error);
                            // Still create the iframe even if loading failed
                            mediaIframe = document.createElement('iframe');
                            mediaIframe.style.width = '100%';
                            mediaIframe.style.height = '100%';
                            mediaIframe.style.border = 'none';
                            mediaIframe.src = 'media.html';
                            mediaEditorContainer.appendChild(mediaIframe);
                        });
                    
                    // Return early since the iframe will be created in the fetch callback
                    return;
                }
            } else {
                // No resource data, just create a basic iframe
                mediaIframe = document.createElement('iframe');
                mediaIframe.style.width = '100%';
                mediaIframe.style.height = '100%';
                mediaIframe.style.border = 'none';
                mediaIframe.src = 'media.html';
            }
            
            // Append the iframe to the container
            mediaEditorContainer.appendChild(mediaIframe);
        }
    }
    
    // Function to show code editor tab
    function showCodeEditor() {
        document.getElementById('editor').classList.add('active');
        document.getElementById('media-editor').classList.remove('active');
        document.getElementById('code-tab-button').classList.add('active');
        document.getElementById('media-tab-button').classList.remove('active');
    }
    
    // Function to show media editor tab
    function showMediaEditor() {
        // Initialize the media editor if needed
        initializeMediaEditor();
        
        document.getElementById('editor').classList.remove('active');
        document.getElementById('media-editor').classList.add('active');
        document.getElementById('code-tab-button').classList.remove('active');
        document.getElementById('media-tab-button').classList.add('active');
    }
    
    // Add event listeners for tab buttons
    document.getElementById('code-tab-button').addEventListener('click', showCodeEditor);
    document.getElementById('media-tab-button').addEventListener('click', showMediaEditor);
    
    // Add event listener for resource update messages from media editor
    window.addEventListener('message', (event) => {
        // Check if the message is a resource update
        if (event.data && event.data.type === 'pyxelResourceUpdate') {
            // Store the resource data as base64
            resourceData = event.data.data;
            console.log('Updated resource data from media editor');
            
            // If the game is running, update it with the new resource data
            if (gameIframe) {
                updateGame();
            }
            
            // Don't automatically switch back to code editor to prevent infinite update loops
        }
    });
    
    // Function to create and download a Pyxel App (.pyxapp) file
    async function downloadPyxelApp() {
        try {
            const code = editor.getValue();
            
            if (!code) {
                console.error("No code to download");
                return;
            }
            
            // Get current example name or use 'pyxel-game' as default
            const currentTitle = document.title.includes('-') ? 
                document.title.split('-')[1].trim().toLowerCase().replace(/\s+/g, '_') : 
                'pyxel_game';
                
            // Generate filename
            const filename = `${currentTitle}.pyxapp`;
            
            // Create a new JSZip instance
            const zip = new JSZip();
            
            // Add the Python code file
            zip.file("app/game.py", code);
            
            // Add the startup script file marker
            zip.file("app/.pyxapp_startup_script", "game.py");
            
            // Add resource file if we have one
            if (resourceData) {
                try {
                    // If it's a base64 string from the media editor
                    if (typeof resourceData === 'string') {
                        if (resourceData.match(/^[A-Za-z0-9+/=]+$/)) {
                            // Convert base64 to binary data
                            const binaryString = atob(resourceData);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            // Use a standard resource file name
                            zip.file("app/game.pyxres", bytes.buffer, {binary: true});
                            console.log("Added base64 resource as game.pyxres");
                        } 
                        // If it's a file path
                        else if (resourceData.includes('/')) {
                            try {
                                const resourceName = resourceData.split('/').pop();
                                const response = await fetch(resourceData);
                                if (!response.ok) {
                                    throw new Error(`Failed to fetch resource: ${response.status} ${response.statusText}`);
                                }
                                const resourceBuffer = await response.arrayBuffer();
                                
                                if (resourceBuffer) {
                                    zip.file(`app/${resourceName}`, resourceBuffer, {binary: true});
                                    console.log(`Added resource file: ${resourceName}`);
                                    
                                    // Make sure the code references this resource
                                    if (code.includes('pyxel.load(')) {
                                        // Update any existing load statement to use the correct filename
                                        code = code.replace(/pyxel\.load\(['"].*?['"]\)/, `pyxel.load('${resourceName}')`);
                                        zip.file("app/game.py", code);
                                    }
                                }
                            } catch (e) {
                                console.error("Error loading resource file path:", e);
                            }
                        }
                    }
                } catch (e) {
                    console.error("Error processing resource data:", e);
                }
            }
            
            // Generate the zip file blob
            const blob = await zip.generateAsync({
                type: "blob",
                compression: "DEFLATE"
            });
            
            // Create a download link and trigger the download
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = filename;
            
            // Add to document, click it, and remove it
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Clean up the URL object
            setTimeout(() => {
                URL.revokeObjectURL(downloadLink.href);
            }, 100);
            
            // Show feedback to the user
            const btn = document.getElementById('download-button');
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Downloaded!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
            
        } catch (e) {
            console.error("Error creating Pyxel App file:", e);
            alert("Error creating download file. See console for details.");
        }
    }
    
    // Add event listener for the download button
    document.getElementById('download-button').addEventListener('click', downloadPyxelApp);
    
    // Function to handle uploading and extracting pyxapp files
    async function uploadPyxelApp(file) {
        try {
            if (!file || !file.name.endsWith('.pyxapp')) {
                console.error("Invalid file type. Please select a .pyxapp file.");
                return;
            }
            
            // Read the file as an ArrayBuffer
            const fileData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
            
            // Load the zip file
            const zip = await JSZip.loadAsync(fileData);
            
            let gamePyContent = null;
            let resourceFile = null;
            
            // First, try to find the startup script
            let startupScript = null;
            try {
                const startupMarkerContent = await zip.file("app/.pyxapp_startup_script").async("text");
                if (startupMarkerContent) {
                    startupScript = startupMarkerContent.trim();
                }
            } catch (e) {
                console.warn("No startup script marker found, will try to find game.py");
            }
            
            // If we have a startup script, use it, otherwise default to game.py
            const mainPyFile = startupScript || "game.py";
            
            // Try to find and extract the main Python file
            try {
                gamePyContent = await zip.file(`app/${mainPyFile}`).async("text");
            } catch (e) {
                console.error(`Could not find main Python file (${mainPyFile}) in the pyxapp package.`);
                alert(`Could not find main Python file (${mainPyFile}) in the pyxapp package.`);
                return;
            }
            
            // Look for resource files
            const resourceFiles = [];
            zip.forEach((relativePath, zipEntry) => {
                if (!zipEntry.dir && relativePath.startsWith("app/") && relativePath.endsWith(".pyxres")) {
                    resourceFiles.push(relativePath);
                }
            });
            
            // If we found a resource file, extract it
            if (resourceFiles.length > 0) {
                try {
                    const resourceData = await zip.file(resourceFiles[0]).async("arraybuffer");
                    // Convert ArrayBuffer to Base64
                    const resourceBase64 = btoa(
                        new Uint8Array(resourceData)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    resourceFile = resourceBase64;
                    
                    // Get the resource filename
                    const resourceFilename = resourceFiles[0].split('/').pop();
                    
                    // Make sure the code references this resource file
                    if (gamePyContent.includes('pyxel.load(')) {
                        gamePyContent = gamePyContent.replace(
                            /pyxel\.load\(['"].*?['"]\)/, 
                            `pyxel.load('${resourceFilename}')`
                        );
                    }
                } catch (e) {
                    console.error("Error extracting resource file:", e);
                }
            }
            
            // Update the editor with the extracted code
            editor.setValue(gamePyContent, -1);
            
            // Update resource data
            resourceData = resourceFile || "";
            
            // Update the game display
            updateGame();
            
            // Update the document title
            const appName = file.name.replace('.pyxapp', '');
            document.title = `Pyxel Playground - ${appName}`;
            
            // Reset the save button state
            updateSaveButtonState(false);
            
            // If we have resource data, update the media editor
            if (resourceFile && mediaIframe) {
                // Remove the old iframe
                const mediaEditorContainer = document.getElementById('media-editor');
                mediaEditorContainer.innerHTML = '';
                mediaIframe = null;
                
                // If media tab is currently active, immediately reinitialize the media editor
                if (document.getElementById('media-editor').classList.contains('active')) {
                    initializeMediaEditor();
                }
            }
            
            // Show feedback to the user
            const btn = document.getElementById('upload-button');
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Loaded!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
            
        } catch (e) {
            console.error("Error processing pyxapp file:", e);
            alert("Error loading pyxapp file. See console for details.");
        }
    }
    
    // Add event listener for the upload button to trigger file selection
    document.getElementById('upload-button').addEventListener('click', () => {
        document.getElementById('pyxapp-file-input').click();
    });
    
    // Add event listener for file input changes
    document.getElementById('pyxapp-file-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            uploadPyxelApp(file);
        }
        // Clear the input so the same file can be selected again
        event.target.value = '';
    });

    // Add drag and drop support for pyxapp files
    const container = document.querySelector('.container');
    
    // Prevent default behavior for drag events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    
    // Add visual feedback for drag events
    ['dragenter', 'dragover'].forEach(eventName => {
        container.addEventListener(eventName, () => {
            container.classList.add('highlight-drop');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, () => {
            container.classList.remove('highlight-drop');
        }, false);
    });
    
    // Handle the dropped file
    container.addEventListener('drop', (e) => {
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.pyxapp')) {
            uploadPyxelApp(file);
        } else {
            alert('Please drop a .pyxapp file.');
        }
    }, false);
    
    // Add styles for drag and drop highlighting
    const style = document.createElement('style');
    style.textContent = `
        .highlight-drop {
            border: 3px dashed #4CAF50 !important;
            background-color: rgba(76, 175, 80, 0.1) !important;
        }
    `;
    document.head.appendChild(style);
    
    document.addEventListener('click', (event) => {
        // Get the Pyxel canvas element (created by Pyxel)
        const pyxelCanvas = document.querySelector('#canvas');
        if (!pyxelCanvas) return;  // Exit if game isn't running

        // Check if click was outside the Pyxel canvas
        if (!pyxelCanvas.contains(event.target)) {
            // Create and dispatch an Escape key event
            const escEvent = new KeyboardEvent('keydown', {
                key: 'Escape',
                code: 'Escape',
                keyCode: 27,
                which: 27,
                bubbles: true,
                cancelable: true
            });
            
            pyxelCanvas.dispatchEvent(escEvent);
        }
    });
  </script>
</body>

</html>